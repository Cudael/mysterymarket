generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id               String     @id @default(cuid())
  clerkId          String     @unique
  email            String     @unique
  name             String?
  avatarUrl        String?
  bio              String?
  stripeAccountId  String?
  stripeOnboarded  Boolean    @default(false)
  role             Role       @default(USER)
  ideas            Idea[]     @relation("CreatorIdeas")
  purchases        Purchase[]
  reviews          Review[]   @relation("BuyerReviews")
  reports          Report[]   @relation("ReporterReports")
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
}

enum Role {
  USER
  CREATOR
  ADMIN
}

model Idea {
  id             String     @id @default(cuid())
  title          String
  teaserText     String?
  teaserImageUrl String?
  hiddenContent  String
  priceInCents   Int
  currency       String     @default("usd")
  unlockType     UnlockType @default(MULTI)
  maxUnlocks     Int?
  category       String?
  tags           String[]   @default([])
  published      Boolean    @default(false)
  creator        User       @relation("CreatorIdeas", fields: [creatorId], references: [id])
  creatorId      String
  purchases      Purchase[]
  reviews        Review[]
  reports        Report[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([creatorId])
  @@index([published, createdAt])
}

enum UnlockType {
  EXCLUSIVE
  MULTI
}

model Purchase {
  id                    String         @id @default(cuid())
  buyer                 User           @relation(fields: [buyerId], references: [id])
  buyerId               String
  idea                  Idea           @relation(fields: [ideaId], references: [id])
  ideaId                String
  amountInCents         Int
  platformFeeInCents    Int
  stripePaymentIntentId String         @unique
  status                PurchaseStatus @default(PENDING)
  refundRequest         RefundRequest?
  createdAt             DateTime       @default(now())

  @@unique([buyerId, ideaId])
  @@index([ideaId])
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  buyer     User     @relation("BuyerReviews", fields: [buyerId], references: [id])
  buyerId   String
  idea      Idea     @relation(fields: [ideaId], references: [id])
  ideaId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([buyerId, ideaId])
  @@index([ideaId])
}

model Report {
  id         String       @id @default(cuid())
  reason     ReportReason
  details    String?
  reporter   User         @relation("ReporterReports", fields: [reporterId], references: [id])
  reporterId String
  idea       Idea         @relation(fields: [ideaId], references: [id])
  ideaId     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())

  @@unique([reporterId, ideaId])
  @@index([ideaId])
  @@index([status])
}

enum ReportReason {
  MISLEADING
  INAPPROPRIATE
  SPAM
  PLAGIARISM
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  DISMISSED
  ACTION_TAKEN
}

model RefundRequest {
  id         String              @id @default(cuid())
  purchase   Purchase            @relation(fields: [purchaseId], references: [id])
  purchaseId String              @unique
  reason     String
  status     RefundRequestStatus @default(PENDING)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
}

enum RefundRequestStatus {
  PENDING
  APPROVED
  DENIED
}
